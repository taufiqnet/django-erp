{% extends 'partials/base_retail.html' %}
{% block title %}Retail - Point of Sale{% endblock %}
{% block content %}
{% load static %}
{% csrf_token %}

<div class="flex flex-col md:flex-row min-h-screen p-4 gap-4">

  <!-- Left Column -->
  <div class="w-full md:w-2/3 space-y-4">
    <!-- Customer Section -->
    <div class="bg-white p-4 shadow-md rounded-md">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold">ðŸ‘¤ Customer</h2>
        <div class="flex gap-2">
          <div class="relative flex-1">
            <select id="customer-select" class="w-full p-2 pl-8 border rounded-md text-sm focus:ring-1 focus:ring-blue-500">
              <option value="">Walk-in Customer</option>
              {% for customer in customers %}
              <option value="{{ customer.id }}" 
                      data-name="{{ customer.first_name }} {{ customer.last_name }}"
                      data-contact="{{ customer.mobile }}"
                      data-email="{{ customer.email|default:'' }}"
                      data-address="{% if customer.address_line1 %}{{ customer.address_line1 }}{% endif %}"
                      data-cid="{{ customer.cid }}">
                {{ customer.contact_id }} - {{ customer.first_name }} {{ customer.last_name }}
              </option>
              {% empty %}
              <option value="" disabled>No customers found</option>
              {% endfor %}
            </select>
            <svg class="absolute left-2 top-3 h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <button id="new-customer-btn" class="bg-blue-600 text-white text-sm px-3 py-1 rounded-md hover:bg-blue-700 transition-colors flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            New
          </button>
        </div>
      </div>
      
      <!-- Customer Info Display -->
      <div id="customer-info" class="hidden">
        <div class="bg-gray-50 p-3 rounded-md">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-medium text-gray-900" id="customer-name"></h3>
              <div class="text-sm text-gray-600 mt-1 space-y-1">
                <p id="customer-contact"></p>
                <p id="customer-email"></p>
                <p id="customer-address"></p>
                <p class="text-xs text-gray-400" id="customer-id"></p>
              </div>
            </div>
            <button id="clear-customer" class="text-gray-400 hover:text-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Section -->
    <div class="bg-white p-4 shadow-md rounded-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">ðŸ§¾ Products</h2>
        <div class="relative w-64">
          <input type="text" id="product-search" placeholder="Search products..." 
                class="w-full pl-8 pr-4 py-1 border rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
          <svg class="absolute left-2 top-2 h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>
      
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        {% for product in products %}
          <div class="product-card flex flex-col items-center border rounded-lg p-2 hover:shadow-md transition-shadow cursor-pointer">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-16 h-16 object-cover rounded mb-2" />
            {% else %}
              <div class="w-16 h-16 flex items-center justify-center bg-gray-100 text-xs text-gray-400 mb-2 rounded">
                No Image
              </div>
            {% endif %}
            <p class="text-sm font-medium text-center">{{ product.name|truncatechars:20 }}</p>
            <p class="text-xs text-gray-500 mb-2">à§³{{ product.price }}</p>
            <button class="add-to-cart-btn w-full bg-blue-600 text-white text-xs px-2 py-1 rounded hover:bg-blue-700 transition-colors" 
                    data-id="{{ product.id }}" 
                    data-name="{{ product.name }}" 
                    data-price="{{ product.price }}"
                    data-tax-type="{{ product.tax_type }}"
                    data-tax-rate="{{ product.tax_rate }}"
                    data-unit="{{ product.unit.abbreviation|default:'pc' }}">
              Add to Cart
            </button>
          </div>
        {% empty %}
          <div class="col-span-full text-center text-gray-500 py-8">
            No products available
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Right Column - Cart Section -->
  <div class="w-full md:w-1/3 bg-white p-4 shadow-md rounded-md">
    <div class="flex justify-between items-center mb-3">
      <h3 class="text-lg font-bold">ðŸ›’ Cart (<span class="cart-count">0</span>)</h3>
      <button class="clear-cart-btn text-xs text-red-600 hover:text-red-800 flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        Clear All
      </button>
    </div>
    
    <div class="cart-items space-y-3 text-sm max-h-[50vh] overflow-y-auto pr-2 mb-4">
      <div class="empty-cart-message text-gray-500 text-center py-4">Your cart is empty</div>
    </div>
    
    <!-- Order Summary -->
    <div class="space-y-2 border-t pt-3">
      <div class="flex justify-between text-sm">
        <span>Subtotal:</span>
        <span class="subtotal-price">à§³0.00</span>
      </div>
      <div class="flex justify-between text-sm">
        <span>Discount:</span>
        <div class="flex items-center gap-2">
          <input type="number" id="discount-input" min="0" max="100" value="0" class="w-12 p-1 border rounded text-right text-sm">
          <span>%</span>
        </div>
      </div>
      <div class="flex justify-between text-sm">
        <span>Tax:</span>
        <span class="tax-amount">à§³0.00</span>
      </div>
      <div class="flex justify-between font-bold text-base mt-2">
        <span>Total:</span>
        <span class="total-price">à§³0.00</span>
      </div>
    </div>
    
    <!-- Payment Options -->
    <div class="mt-4 space-y-3">
      <div>
        <label class="block text-sm font-medium mb-1">Payment Method</label>
        <select id="payment-method" class="w-full p-2 border rounded-md text-sm">
          {% for method in payment_methods %}
          <option value="{{ method.0 }}">{{ method.1 }}</option>
          {% endfor %}
        </select>
      </div>
    
      <div id="cash-payment" class="space-y-2">
        <div class="flex justify-between text-sm">
          <span>Amount Paid:</span>
          <input type="number" id="amount-paid" min="0" step="0.01" class="w-24 p-1 border rounded text-right text-sm">
        </div>
        <div class="flex justify-between text-sm">
          <span>Change Due:</span>
          <span id="change-due" class="font-medium">à§³0.00</span>
        </div>
      </div>
    </div>
    
    
    <!-- Checkout Button -->
    <button class="checkout-btn w-full bg-green-600 text-white py-2.5 rounded-md hover:bg-green-700 disabled:bg-gray-300 transition-colors mt-4 flex items-center justify-center gap-2" disabled>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      Complete Sale
    </button>
  </div>
</div>

<!-- New Customer Modal -->
<div id="new-customer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
    <div class="flex justify-between items-center border-b p-4">
      <h3 class="text-lg font-semibold">Add New Customer</h3>
      <button id="close-modal" class="text-gray-500 hover:text-gray-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="p-4">
      <form id="customer-form" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">First Name*</label>
            <input type="text" name="first_name" required 
                  class="w-full p-2 border rounded-md text-sm focus:ring-1 focus:ring-blue-500">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Last Name</label>
            <input type="text" name="last_name" 
                  class="w-full p-2 border rounded-md text-sm focus:ring-1 focus:ring-blue-500">
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Mobile*</label>
          <input type="tel" name="mobile" required 
                class="w-full p-2 border rounded-md text-sm focus:ring-1 focus:ring-blue-500"
                pattern="[0-9]{10,15}" title="Enter a valid phone number">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input type="email" name="email" 
                class="w-full p-2 border rounded-md text-sm focus:ring-1 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-1">Address</label>
          <textarea name="address" rows="2" 
                  class="w-full p-2 border rounded-md text-sm focus:ring-1 focus:ring-blue-500"></textarea>
        </div>
        
        <div class="pt-2">
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors">
            Save Customer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Receipt Template -->
<div id="receipt-template" class="hidden">
  <div class="bg-white p-4 w-64">
    <div class="text-center mb-3">
      <h2 class="text-xl font-bold">{{ request.user.retailshop.name }}</h2>
      <p class="text-xs">{{ request.user.retailshop.address }}</p>
      <p class="text-xs">Tel: {{ request.user.retailshop.phone }}</p>
      {% if request.user.retailshop.vat_number %}
        <p class="text-xs">VAT: {{ request.user.retailshop.vat_number }}</p>
      {% endif %}
    </div>

    <div class="border-b border-black mb-2"></div>

    <div class="flex justify-between text-xs mb-1">
      <span>Date:</span>
      <span id="receipt-date"></span>
    </div>
    <div class="flex justify-between text-xs mb-2">
      <span>Invoice #:</span>
      <span id="receipt-invoice"></span>
    </div>
    <div class="flex justify-between text-xs mb-3">
      <span>Customer:</span>
      <span id="receipt-customer">Walk-in</span>
    </div>

    <div class="border-b border-black mb-2"></div>

    <div id="receipt-items" class="mb-2 text-xs space-y-1"></div>

    <div class="border-b border-black mb-2"></div>

    <div class="flex justify-between text-sm mb-1">
      <span>Subtotal:</span>
      <span id="receipt-subtotal">à§³0.00</span>
    </div>
    <div class="flex justify-between text-sm mb-1">
      <span>Discount:</span>
      <span id="receipt-discount">à§³0.00</span>
    </div>
    <div class="flex justify-between text-sm mb-1">
      <span>Tax:</span>
      <span id="receipt-tax">à§³0.00</span>
    </div>
    <div class="flex justify-between font-bold text-sm mb-2">
      <span>Total:</span>
      <span id="receipt-total">à§³0.00</span>
    </div>

    <div class="border-b border-black mb-2"></div>

    <div class="flex justify-between text-xs mb-1">
      <span>Payment:</span>
      <span id="receipt-payment">Cash</span>
    </div>
    <div class="flex justify-between text-xs mb-1">
      <span>Amount Paid:</span>
      <span id="receipt-paid">à§³0.00</span>
    </div>
    <div class="flex justify-between text-xs mb-3">
      <span>Change:</span>
      <span id="receipt-change">à§³0.00</span>
    </div>

    <div class="border-b border-black mb-2"></div>

    <div class="text-center text-xs mt-3">
      <p>Thank you for shopping with us!</p>
      <p>** No return without receipt **</p>
      <p>Developed by RetailPro</p>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Get CSRF token
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
      const csrftoken = getCookie('csrftoken');
  
      // State Management
      const state = {
          cart: {},
          customer: null,
          discount: 0,
          paymentMethod: 'cash',
          amountPaid: 0
      };
  
      // DOM Elements with null checks
      const getElement = (selector) => {
          const el = document.querySelector(selector);
          if (!el) console.error(`Element not found: ${selector}`);
          return el;
      };
  
      const elements = {
          customerSelect: getElement('#customer-select'),
          customerInfo: getElement('#customer-info'),
          newCustomerBtn: getElement('#new-customer-btn'),
          clearCustomerBtn: getElement('#clear-customer'),
          newCustomerModal: getElement('#new-customer-modal'),
          closeModalBtn: getElement('#close-modal'),
          customerForm: getElement('#customer-form'),
          cartItemsContainer: getElement('.cart-items'),
          cartCount: getElement('.cart-count'),
          subtotalPrice: getElement('.subtotal-price'),
          taxAmount: getElement('.tax-amount'),
          totalPrice: getElement('.total-price'),
          discountInput: getElement('#discount-input'),
          paymentMethod: getElement('#payment-method'),
          cashPayment: getElement('#cash-payment'),
          amountPaid: getElement('#amount-paid'),
          changeDue: getElement('#change-due'),
          checkoutBtn: getElement('.checkout-btn'),
          clearCartBtn: getElement('.clear-cart-btn'),
          productSearch: getElement('#product-search'),
          receiptTemplate: getElement('#receipt-template')
      };
  
      // Initialize only if required elements exist
      if (elements.cartItemsContainer && elements.checkoutBtn) {
          initEventListeners();
          updatePaymentUI();
      }
  
      function initEventListeners() {
          // Customer Management
          if (elements.customerSelect) elements.customerSelect.addEventListener('change', handleCustomerSelect);
          if (elements.newCustomerBtn) elements.newCustomerBtn.addEventListener('click', showNewCustomerModal);
          if (elements.clearCustomerBtn) elements.clearCustomerBtn.addEventListener('click', clearCustomer);
          if (elements.closeModalBtn) elements.closeModalBtn.addEventListener('click', hideNewCustomerModal);
          if (elements.customerForm) elements.customerForm.addEventListener('submit', handleNewCustomerSubmit);
  
          // Cart Management
          document.addEventListener('click', handleCartActions);
          if (elements.clearCartBtn) elements.clearCartBtn.addEventListener('click', clearCart);
          if (elements.discountInput) elements.discountInput.addEventListener('change', updateDiscount);
          if (elements.paymentMethod) elements.paymentMethod.addEventListener('change', updatePaymentMethod);
          if (elements.amountPaid) elements.amountPaid.addEventListener('input', updateAmountPaid);
  
          // Product Search
          if (elements.productSearch) elements.productSearch.addEventListener('input', searchProducts);
  
          // Checkout
          if (elements.checkoutBtn) elements.checkoutBtn.addEventListener('click', processCheckout);
  
          // Close modal when clicking outside
          if (elements.newCustomerModal) {
              elements.newCustomerModal.addEventListener('click', function(e) {
                  if (e.target === elements.newCustomerModal) {
                      hideNewCustomerModal();
                  }
              });
          }
      }
  
      function handleCustomerSelect() {
          const selectedOption = this.options[this.selectedIndex];
          if (selectedOption && selectedOption.value) {
              state.customer = {
                  id: selectedOption.value,
                  name: selectedOption.dataset.name,
                  contact: selectedOption.dataset.contact,
                  email: selectedOption.dataset.email,
                  address: selectedOption.dataset.address,
                  cid: selectedOption.dataset.cid
              };
              displayCustomerInfo();
          } else {
              clearCustomer();
          }
      }
  
      function displayCustomerInfo() {
          if (!elements.customerInfo || !state.customer) return;
          
          document.getElementById('customer-name').textContent = state.customer.name;
          document.getElementById('customer-contact').textContent = state.customer.contact;
          document.getElementById('customer-email').textContent = state.customer.email || 'No email';
          document.getElementById('customer-address').textContent = state.customer.address || 'No address';
          document.getElementById('customer-id').textContent = state.customer.cid ? `ID: ${state.customer.cid}` : '';
          elements.customerInfo.classList.remove('hidden');
      }
  
      function clearCustomer() {
          if (elements.customerSelect) elements.customerSelect.value = '';
          state.customer = null;
          if (elements.customerInfo) elements.customerInfo.classList.add('hidden');
      }
  
      function showNewCustomerModal() {
          if (elements.newCustomerModal) {
              elements.newCustomerModal.classList.remove('hidden');
              document.body.style.overflow = 'hidden';
          }
      }
  
      function hideNewCustomerModal() {
          if (elements.newCustomerModal) {
              elements.newCustomerModal.classList.add('hidden');
              document.body.style.overflow = '';
              if (elements.customerForm) elements.customerForm.reset();
          }
      }
  
      function handleNewCustomerSubmit(e) {
          e.preventDefault();
          if (!elements.customerForm) return;
          
          const formData = new FormData(elements.customerForm);
          
          // Client-side validation
          const firstName = formData.get('first_name');
          const mobile = formData.get('mobile');
          
          if (!firstName || !mobile) {
              showNotification('First name and mobile are required', 'error');
              return;
          }
  
          // Show loading state
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.innerHTML;
          submitBtn.innerHTML = `
              <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Saving...
          `;
          submitBtn.disabled = true;
  
          fetch("{% url 'retail:add_customer' %}", {
              method: 'POST',
              headers: {
                  'X-CSRFToken': csrftoken,
                  'Accept': 'application/json'
              },
              body: formData
          })
          .then(response => {
              if (!response.ok) {
                  return response.json().then(err => { 
                      throw { 
                          message: err.message || 'Failed to save customer',
                          errors: err.errors || null 
                      }; 
                  });
              }
              return response.json();
          })
          .then(data => {
              if (data.success) {
                  // Create and add the new option
                  const option = new Option(
                      `${data.contact_id} - ${data.first_name} ${data.last_name}`,
                      data.id
                  );
                  option.dataset.name = `${data.first_name} ${data.last_name}`;
                  option.dataset.contact = data.mobile;
                  option.dataset.email = data.email || '';
                  option.dataset.address = data.address_line1 || '';
                  option.dataset.cid = data.cid;
                  
                  if (elements.customerSelect) {
                      elements.customerSelect.add(option);
                      elements.customerSelect.value = data.id;
                      handleCustomerSelect.call(elements.customerSelect);
                  }
                  
                  hideNewCustomerModal();
                  showNotification('Customer added successfully!', 'success');
              } else {
                  throw { message: data.message || 'Failed to add customer' };
              }
          })
          .catch(error => {
              console.error('Customer save error:', error);
              let errorMessage = error.message || 'Failed to save customer';
              
              if (error.errors) {
                  errorMessage = Object.entries(error.errors)
                      .map(([field, errors]) => {
                          // Handle both string and array error messages
                          const errorText = Array.isArray(errors) ? errors.join(', ') : errors;
                          return `<strong>${field}:</strong> ${errorText}`;
                      })
                      .join('<br>');
              }
              
              showNotification(errorMessage, 'error');
          })
          .finally(() => {
              submitBtn.innerHTML = originalBtnText;
              submitBtn.disabled = false;
          });
      }
  
      function showNotification(message, type = 'info') {
          // Implement your notification system here
          // Could use Toastr, SweetAlert, or a custom solution
          alert(`${type.toUpperCase()}: ${message}`);
      }
  
      function handleCartActions(e) {
          // Add to cart
          const addToCartBtn = e.target.closest('.add-to-cart-btn');
          if (addToCartBtn) {
              e.preventDefault(); // Prevent default button behavior
              const id = addToCartBtn.dataset.id;
              const name = addToCartBtn.dataset.name;
              const price = parseFloat(addToCartBtn.dataset.price);
              const taxType = addToCartBtn.dataset.taxType;
              const taxRate = parseFloat(addToCartBtn.dataset.taxRate) || 0;
              const unit = addToCartBtn.dataset.unit || 'pc';
              
              // Check if product already in cart
              if (!state.cart[id]) {
                  state.cart[id] = { 
                      name, 
                      price, 
                      quantity: 1, 
                      taxType, 
                      taxRate,
                      unit
                  };
              } else {
                  state.cart[id].quantity += 1;
              }
              
              updateCartUI();
              
              // Visual feedback
              const productCard = addToCartBtn.closest('.product-card');
              if (productCard) {
                  productCard.classList.add('bg-green-50');
                  setTimeout(() => {
                      productCard.classList.remove('bg-green-50');
                  }, 300);
              }
              return;
          }
          
          // Increase quantity
          if (e.target.classList.contains('increase-qty')) {
              const id = e.target.dataset.id;
              if (state.cart[id]) {
                  state.cart[id].quantity += 1;
                  updateCartUI();
              }
              return;
          }
          
          // Decrease quantity
          if (e.target.classList.contains('decrease-qty')) {
              const id = e.target.dataset.id;
              if (state.cart[id]) {
                  if (state.cart[id].quantity > 1) {
                      state.cart[id].quantity -= 1;
                  } else {
                      delete state.cart[id];
                  }
                  updateCartUI();
              }
              return;
          }
          
          // Remove item
          const removeItemBtn = e.target.closest('.remove-item');
          if (removeItemBtn) {
              const id = removeItemBtn.dataset.id;
              if (state.cart[id]) {
                  delete state.cart[id];
                  updateCartUI();
              }
              return;
          }
      }
  
      function updateCartUI() {
          if (!elements.cartItemsContainer || !elements.cartCount || !elements.subtotalPrice || 
              !elements.taxAmount || !elements.totalPrice || !elements.checkoutBtn || !elements.clearCartBtn) {
              return;
          }
  
          elements.cartItemsContainer.innerHTML = '';
          
          let subtotal = 0;
          let itemCount = 0;
          
          for (const id in state.cart) {
              const item = state.cart[id];
              const itemTotal = item.quantity * item.price;
              subtotal += itemTotal;
              itemCount += item.quantity;
              
              const itemHTML = `
                  <div class="cart-item flex justify-between items-center border-b py-2" data-product-id="${id}">
                      <div class="flex-1">
                          <span class="item-name font-medium">${item.name}</span>
                          <div class="text-xs text-gray-500 space-y-1">
                              <p>à§³${item.price.toFixed(2)} x ${item.quantity} ${item.unit}</p>
                              <p>Tax: ${item.taxType} (${item.taxRate}%)</p>
                          </div>
                      </div>
                      <div class="flex items-center gap-2">
                          <button class="decrease-qty text-xs bg-gray-200 px-2 rounded" data-id="${id}">-</button>
                          <span class="item-qty w-6 text-center">${item.quantity}</span>
                          <button class="increase-qty text-xs bg-gray-200 px-2 rounded" data-id="${id}">+</button>
                          <button class="remove-item text-red-500 hover:text-red-700 ml-2" data-id="${id}">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                          </button>
                      </div>
                      <div class="text-sm font-medium">à§³${itemTotal.toFixed(2)}</div>
                  </div>`;
              elements.cartItemsContainer.innerHTML += itemHTML;
          }
          
          if (itemCount === 0) {
              elements.cartItemsContainer.innerHTML = '<div class="empty-cart-message text-gray-500 text-center py-4">Your cart is empty</div>';
              elements.checkoutBtn.disabled = true;
              elements.clearCartBtn.classList.add('hidden');
          } else {
              elements.checkoutBtn.disabled = false;
              elements.clearCartBtn.classList.remove('hidden');
          }
          
          elements.cartCount.textContent = itemCount;
          calculateTotals();
      }
  
      function clearCart() {
          if (Object.keys(state.cart).length > 0 && confirm('Are you sure you want to clear the cart?')) {
              state.cart = {};
              updateCartUI();
          }
      }
  
      function calculateTotals() {
          if (!elements.subtotalPrice || !elements.taxAmount || !elements.totalPrice || !elements.changeDue) {
              return;
          }
  
          let subtotal = 0;
          let totalTax = 0;
          
          for (const id in state.cart) {
              const item = state.cart[id];
              const itemTotal = item.quantity * item.price;
              subtotal += itemTotal;
              
              // Calculate tax for each item based on its tax rate
              const itemTax = itemTotal * (item.taxRate / 100);
              totalTax += itemTax;
          }
          
          const discountAmount = subtotal * (state.discount / 100);
          const total = (subtotal - discountAmount) + totalTax;
          
          elements.subtotalPrice.textContent = `à§³${subtotal.toFixed(2)}`;
          elements.taxAmount.textContent = `à§³${totalTax.toFixed(2)}`;
          elements.totalPrice.textContent = `à§³${total.toFixed(2)}`;
          
          // Update change due if amount paid exists
          if (state.amountPaid > 0) {
              updateChangeDue(total);
          }
      }
  
      function updateDiscount() {
          state.discount = parseFloat(this.value) || 0;
          calculateTotals();
      }
  
      function updatePaymentMethod() {
          state.paymentMethod = this.value;
          updatePaymentUI();
      }
  
      function updatePaymentUI() {
          if (!elements.cashPayment) return;
          
          if (state.paymentMethod === 'cash') {
              elements.cashPayment.classList.remove('hidden');
          } else {
              elements.cashPayment.classList.add('hidden');
          }
      }
  
      function updateAmountPaid() {
          state.amountPaid = parseFloat(this.value) || 0;
          const total = parseFloat(elements.totalPrice.textContent.replace('à§³', ''));
          updateChangeDue(total);
      }
  
      function updateChangeDue(total) {
          if (!elements.changeDue) return;
          
          const change = state.amountPaid - total;
          elements.changeDue.textContent = `à§³${change > 0 ? change.toFixed(2) : '0.00'}`;
      }
  
      function searchProducts() {
          const searchTerm = this.value.toLowerCase();
          document.querySelectorAll('.product-card').forEach(card => {
              const productName = card.querySelector('p').textContent.toLowerCase();
              card.style.display = productName.includes(searchTerm) ? 'flex' : 'none';
          });
      }
  
      function processCheckout() {
        if (Object.keys(state.cart).length === 0) {
            alert('Your cart is empty!');
            return;
        }
        
        // Validate cash payment
        const total = parseFloat(elements.totalPrice.textContent.replace('à§³', ''));
        if (state.paymentMethod === 'cash') {
          if (isNaN(state.amountPaid) || state.amountPaid < 0) {
              alert('Please enter a valid (non-negative) amount paid.');
              return;
          }
          // The check for amount_paid < total has been removed to allow partial payments.
      }
    
        // Prepare sale data with payment details
        const saleData = {
            items: Object.entries(state.cart).map(([productId, item]) => ({
                product_id: productId,
                quantity: item.quantity,
                price: item.price,
                tax_type: item.taxType,
                tax_rate: item.taxRate
            })),
            customer_id: state.customer ? state.customer.id : null,
            payment_method: state.paymentMethod,
            discount: state.discount,
            amount_paid: state.amountPaid,
            business_id: {{ request.user.profile.business.id }},
            // Explicit payment status for cash payments
            is_paid: state.paymentMethod === 'cash' && state.amountPaid >= total,
            due_amount: state.paymentMethod === 'cash' ? Math.max(0, total - state.amountPaid) : total
        };
        
        // Disable checkout button during processing
        elements.checkoutBtn.disabled = true;
        elements.checkoutBtn.innerHTML = `
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Processing...
        `;
        
        // Send sale data to server
        fetch("{% url 'retail:process_sale' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(saleData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Generate receipt
                generateReceipt(data);
                
                // Reset POS
                state.cart = {};
                state.discount = 0;
                state.amountPaid = 0;
                updateCartUI();
                if (elements.discountInput) elements.discountInput.value = '0';
                if (elements.amountPaid) elements.amountPaid.value = '';
                if (elements.changeDue) elements.changeDue.textContent = 'à§³0.00';
                
                // Show success with payment status
                const paymentStatus = data.is_paid ? 'PAID' : 'PARTIALLY PAID';
                alert(`Sale completed successfully!\nInvoice #: ${data.invoice_number}\nStatus: ${paymentStatus}`);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred during checkout');
        })
        .finally(() => {
            if (elements.checkoutBtn) {
                elements.checkoutBtn.disabled = false;
                elements.checkoutBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Complete Sale
                `;
            }
        });
    }
  
      function generateReceipt(saleData) {
          if (!elements.receiptTemplate) return;
          
          // Populate receipt data
          document.getElementById('receipt-date').textContent = new Date().toLocaleString();
          document.getElementById('receipt-invoice').textContent = saleData.invoice_number;
          document.getElementById('receipt-customer').textContent = state.customer ? state.customer.name : 'Walk-in';
          
          // Add items
          const receiptItems = document.getElementById('receipt-items');
          receiptItems.innerHTML = '';
          
          for (const id in state.cart) {
              const item = state.cart[id];
              const itemTotal = item.quantity * item.price;
              
              const itemHTML = `
                  <div class="flex justify-between">
                      <span>${item.name} x${item.quantity} ${item.unit}</span>
                      <span>à§³${itemTotal.toFixed(2)}</span>
                  </div>`;
              receiptItems.innerHTML += itemHTML;
          }
          
          // Calculate totals
          let subtotal = 0;
          let totalTax = 0;
          
          for (const id in state.cart) {
              const item = state.cart[id];
              const itemTotal = item.quantity * item.price;
              subtotal += itemTotal;
              totalTax += itemTotal * (item.taxRate / 100);
          }
          
          const discountAmount = subtotal * (state.discount / 100);
          const total = (subtotal - discountAmount) + totalTax;
          
          // Set totals
          document.getElementById('receipt-subtotal').textContent = `à§³${subtotal.toFixed(2)}`;
          document.getElementById('receipt-discount').textContent = `-à§³${discountAmount.toFixed(2)}`;
          document.getElementById('receipt-tax').textContent = `à§³${totalTax.toFixed(2)}`;
          document.getElementById('receipt-total').textContent = `à§³${total.toFixed(2)}`;
          document.getElementById('receipt-payment').textContent = state.paymentMethod.charAt(0).toUpperCase() + state.paymentMethod.slice(1);
          document.getElementById('receipt-paid').textContent = `à§³${state.amountPaid.toFixed(2)}`;
          document.getElementById('receipt-change').textContent = `à§³${(state.amountPaid - total).toFixed(2)}`;
          
          // Print receipt
          printReceipt();
      }
  
      function printReceipt() {
          if (!elements.receiptTemplate) return;
          
          const receiptContent = elements.receiptTemplate.innerHTML;
          const printWindow = window.open('', '_blank', 'width=400,height=600');
          
          printWindow.document.write(`
              <!DOCTYPE html>
              <html>
                  <head>
                      <title>Receipt</title>
                      <style>
                          body { font-family: Arial, sans-serif; font-size: 12px; padding: 10px; }
                          .text-center { text-align: center; }
                          .border-b { border-bottom: 1px solid #000; margin: 5px 0; }
                          .flex { display: flex; justify-content: space-between; }
                          .mb-1 { margin-bottom: 4px; }
                          .mb-2 { margin-bottom: 8px; }
                          .mb-3 { margin-bottom: 12px; }
                          .font-bold { font-weight: bold; }
                          .space-y-1 > * + * { margin-top: 4px; }
                          .space-y-2 > * + * { margin-top: 8px; }
                          .space-y-3 > * + * { margin-top: 12px; }
                      </style>
                  </head>
                  <body onload="window.print(); setTimeout(() => window.close(), 1000);">
                      ${receiptContent}
                  </body>
              </html>
          `);
          
          printWindow.document.close();
      }
  });
</script>
{% endblock %}